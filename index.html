<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Голосовой калькулятор</title>
  <link rel="icon" type="image/png" href="img/icon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f0f2f5; --fg:#111; --muted:#666; --primary:#0a84ff; --card:#fff; --divider: rgba(0,0,0,.08);
      --safe-top: env(safe-area-inset-top); --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right); --safe-bottom: env(safe-area-inset-bottom);
    }
    [data-theme="dark"]{ --bg:#0c0d0f; --fg:#f5f5f7; --muted:#a0a0a0; --primary:#0a84ff; --card:#14161a; --divider: rgba(255,255,255,.08); }
    *{ box-sizing:border-box; }
    html,body{ height:100vh; min-height:100vh; overflow:hidden; overscroll-behavior:none; }
@supports (height: 100dvh){
  html,body{ height:100dvh; min-height:100dvh; }
}
    body{ margin:0; background:var(--bg); color:var(--fg);
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }

    /* убираем системные хайлайты вокруг кнопок */
    button, select { -webkit-tap-highlight-color: transparent; }
    .btn:focus, .navbtn:focus, .hamb:focus, select:focus { outline: none; }

    .screen{ position:relative; background:var(--card); height:100%; width:100%; overflow:hidden;
      padding: calc(var(--safe-top) + 16px) calc(var(--safe-right) + 16px) calc(var(--safe-bottom) + 20px) calc(var(--safe-left) + 16px);
      display:flex; align-items:stretch; justify-content:center; }
    .wrap{ width:min(640px, 96vw); height:100%; overflow:hidden; display:flex; flex-direction:column; gap:0; padding-top:12px; }
    .view{ display:none; flex-direction:column; min-height:calc(100dvh - 64px - var(--safe-top) - var(--safe-bottom)); }
    .view.active{ display:flex; }

    .header{ text-align:center; padding: 8px 16px 0 16px; position:relative; }
    h1{ margin:12px 0 8px; font-size:28px; font-weight:800; }
    #status{ color:var(--muted); min-height:24px; margin:0 0 12px;
      display:flex; align-items:center; justify-content:center; text-align:center; }

    #full{ font-weight:800; font-size:42px; color:var(--primary);
      min-height:52px; margin:8px 0 18px; text-align:center; word-break:break-word; }

    .center{ display:flex; justify-content:center; align-items:center; width:100%; margin-top:6px; }
    .btn{ display:grid; place-items:center; border:0; cursor:pointer; user-select:none; touch-action:manipulation;
      background:var(--primary); color:#fff; box-shadow:0 8px 20px rgba(10,132,255,0.28); transition: transform .08s ease; }
    .btn:active{ transform: scale(.98); }
    .btn.circle{ width:160px; height:160px; border-radius:9999px; }
    .btn .title{ font-weight:800; font-size:16px; letter-spacing:.4px; }

    h2.his{ margin: 12px auto 8px; font-size: 20px; font-weight: 800; text-align: center; }

    /* История + фиксированная кнопка очистки внутри окна */
    .history-card{ position:relative; width:min(560px, 92%); margin:8px auto calc(32px + var(--safe-bottom)); border:1px solid var(--divider); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; height:clamp(240px, 42vh, 420px); background:var(--card); }
    ul.history{ list-style:none; padding:8px 8px 92px 8px; margin:0; width:100%; flex:1; overflow:auto; }
    ul.history li{ padding:10px 12px; border-bottom:1px solid var(--divider); font-size:14px; }
    ul.history li:last-child{ border-bottom:0; }
    .history-footer{ position:absolute; left:0; right:0; bottom:8px; border-top:1px solid var(--divider); padding:8px; display:flex; justify-content:flex-end; background:var(--card); z-index:1; }
    .btn.secondary{ background:transparent; color:var(--fg); border:1px solid var(--divider);
      box-shadow:none; border-radius:16px; padding:10px 14px; width:auto; height:auto; }

    /* Бургер */
    .hamb{ position:fixed; top:calc(var(--safe-top) + 36px); left:calc(var(--safe-left) + 14px);
      width:48px; height:48px; border:0; border-radius:14px; background:var(--primary); color:#fff;
      font-size:24px; font-weight:800; display:grid; place-items:center;
      box-shadow:0 6px 16px rgba(10,132,255,.35); cursor:pointer; z-index:1100; }

    /* Шторка */
    .drawer{ position: fixed; inset: 0 auto 0 0; width: min(300px, 90vw); background: var(--card); color: var(--fg);
      box-shadow: 0 10px 30px rgba(0,0,0,.2); transform: translateX(-100%); transition: none; will-change: transform; z-index: 1001;
      padding: 136px 18px 18px; overflow: auto; touch-action: none; }
    .scrim{ position: fixed; inset: 0; background: rgba(0,0,0,.6); opacity: 0; pointer-events: none; transition: none; will-change: opacity; z-index: 1000; touch-action: none; }
    #edge{ position:fixed; inset:0 auto 0 0; width:24px; z-index:1002; touch-action:none; background:transparent; }

    .navbtn{ -webkit-appearance:none; appearance:none; display:block; width:100%; background:var(--primary); color:#fff; border:0; border-radius:22px;
      padding:18px 20px; margin:14px 0 0; text-align:left; font-weight:800; font-size:20px; box-shadow:0 10px 20px rgba(10,132,255,.25); cursor:pointer; }
    .navbtn:active{ transform:translateY(1px); }

    /* О приложении */
    .about-body{ flex:1; display:flex; flex-direction:column; gap:16px; padding:0 16px; }
    .about-footer{ text-align:center; color:var(--muted); padding-top:6px; margin-bottom:calc(6px + var(--safe-bottom)); }
    .policy{ margin:0; max-height:60vh; overflow:auto; padding:12px; border:1px solid var(--divider); border-radius:12px; }
    .policy h2{ margin:0 0 8px; font-size:20px; font-weight:800; }
    .policy h3{ margin:12px 0 6px; font-size:16px; font-weight:800; }
    .policy p, .policy li { line-height: 1.45; }

    .dots span{ display:inline-block; width:8px; height:8px; background:var(--primary); border-radius:50%; margin:0 3px; animation:b 1.4s infinite ease-in-out both; }
    .dots span:nth-child(1){ animation-delay:-.32s } .dots span:nth-child(2){ animation-delay:-.16s }
    @keyframes b{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
  </style>
</head>
<body>
  <div id="edge"></div>
  <button id="btnMenu" class="hamb" aria-label="Меню">≡</button>

  <aside id="drawer" class="drawer" aria-hidden="true">
    <div style="font-weight:800; font-size:24px; margin-bottom:8px;">Меню</div>
    <button class="navbtn" data-view="calc">Калькулятор</button>
    <button class="navbtn" data-view="settings">Настройки</button>
    <button class="navbtn" data-view="about">О приложении</button>
  </aside>
  <div id="scrim" class="scrim"></div>

  <main class="screen">
    <div class="wrap">
      <!-- Калькулятор -->
      <section id="view-calc" class="view active">
        <div class="header">
          <h1>Голосовой калькулятор</h1>
          <p id="status"></p>
        </div>
        <div id="full"></div>
        <div class="center">
          <button id="btnListen" class="btn circle"><span class="title" id="btnTitle">НАЖМИТЕ</span></button>
        </div>
        <div style="height:12px"></div>
        <h2 class="his">История вычислений</h2>
        <div class="history-card">
          <ul id="historyList" class="history"></ul>
          <div class="history-footer">
            <button id="btnClearHistory" class="btn secondary"><span class="title">Очистить</span></button>
          </div>
        </div>
      </section>

      <!-- Настройки -->
      <section id="view-settings" class="view">
        <div class="header"><h1>Настройки</h1></div>
        <div class="about-body" style="gap:10px">
          <label style="display:flex; align-items:center; gap:12px;">
            <span>Тема</span>
            <select id="themeSelect">
              <option value="light">Светлая</option>
              <option value="dark">Тёмная</option>
            </select>
          </label>
        </div>
      </section>

      <!-- О приложении -->
      <section id="view-about" class="view">
        <div class="header"><h1>О приложении</h1></div>
        <div class="about-body">
          <article class="policy">
            <h2>Политика конфиденциальности приложения «Голосовой калькулятор»</h2>
            <p><b>Дата последнего обновления:</b> 12 сентября 2025 г.</p>
            <h3>1. Общие положения</h3>
            <p>Мобильное приложение «Голосовой калькулятор» (далее — «Приложение») предназначено для голосовых вычислений. Используя Приложение, пользователь соглашается с условиями настоящей Политики.</p>
            <h3>2. Сбор и использование данных</h3>
            <ul>
              <li>Приложение не собирает и не хранит персональные данные пользователей.</li>
              <li>Голосовые команды обрабатываются локально на устройстве исключительно для выполнения вычислений и не передаются на сторонние серверы.</li>
            </ul>
            <h3>3. Разрешения и доступы</h3>
            <p>Приложение запрашивает доступ к:</p>
            <ul>
              <li><b>Микрофону</b> — для распознавания голосовых команд.</li>
            </ul>
            <h3>4. Передача третьим лицам</h3>
            <p>Персональные данные не продаются и не передаются третьим лицам. В приложении отсутствуют встроенные модули аналитики и рекламы.</p>
            <h3>5. Хранение и защита данных</h3>
            <p>История вычислений, если пользователь её включает, хранится только локально и может быть удалена через интерфейс Приложения. Серверной части для обработки данных нет.</p>
            <h3>6. Права пользователя</h3>
            <ul>
              <li>отключить доступ к микрофону в системных настройках;</li>
              <li>очистить историю вычислений (если она включена);</li>
              <li>удалить Приложение, полностью удалив все локальные данные.</li>
            </ul>
            <h3>7. Дети</h3>
            <p>Приложение предназначено для широкой аудитории и не собирает данные детей.</p>
            <h3>8. Изменения политики</h3>
            <p>Разработчик вправе обновлять настоящую Политику. Дата последней редакции всегда указывается в актуальной версии.</p>
            <h3>9. Контакты</h3>
            <p>По вопросам конфиденциальности можно связаться с разработчиком по адресу: <b>gameloft235@gmail.com</b>.</p>
          </article>
          <div class="about-footer">Версия <b>1.0.0</b></div>
        </div>
      </section>
    </div>
  </main>

  <script src="cordova.js"></script>
  <script>
  (function(){
    const $  = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    /* ===== Тема ===== */
    const THEME_KEY='app.theme', themeSelect=$('#themeSelect');
    function applyTheme(v){ document.documentElement.setAttribute('data-theme', v); }
    (function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      const initial = saved || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      applyTheme(initial);
      themeSelect.value = initial;
      themeSelect.addEventListener('change',()=>{ const v=themeSelect.value; localStorage.setItem(THEME_KEY,v); applyTheme(v); });
    })();

    /* ===== Шторка (свайпы) ===== */
    const drawer=$('#drawer'), scrim=$('#scrim'), btnMenu=$('#btnMenu'), edge=$('#edge');
    let isOpen=false, dragging=false, mode='', startX=0, lastX=0, lastT=0, vX=0, w=0, pos=-300;
    const measure=()=>{ w=drawer.getBoundingClientRect().width||280; };
    const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
    const setPos=px=>{ pos=clamp(px,-w,0); drawer.style.transform=`translateX(${pos}px)`; const k=1+pos/w; scrim.style.opacity=(0.6*k).toFixed(3); scrim.style.pointerEvents=k>0.02?'auto':'none'; };
    const stopTr=()=>{ drawer.style.transition='none'; scrim.style.transition='none'; };
    const animateTo=px=>{ drawer.style.transition='transform 280ms cubic-bezier(.2,.8,.2,1)'; scrim.style.transition='opacity 280ms cubic-bezier(.2,.8,.2,1)'; requestAnimationFrame(()=>setPos(px)); setTimeout(stopTr,300); };
    const openDrawer = ()=>{ measure(); isOpen=true;  animateTo(0); };
    const closeDrawer= ()=>{ measure(); isOpen=false; animateTo(-w); };
    const toggleDrawer=()=> isOpen?closeDrawer():openDrawer();
    btnMenu.addEventListener('click',e=>{ e.preventDefault(); toggleDrawer(); });
    scrim.addEventListener('click', closeDrawer);
    function beginOpen(x){ measure(); dragging=true; mode='open';  startX=lastX=x; lastT=performance.now(); vX=0; stopTr(); setPos(-w); }
    function beginClose(x){ measure(); dragging=true; mode='close'; startX=lastX=x; lastT=performance.now(); vX=0; stopTr(); setPos(0); }
    function moveTo(x){ const dx=x-startX; if(mode==='open') setPos(-w+dx); else setPos(0+dx); const now=performance.now(), dt=now-lastT; if(dt>0){ vX=(x-lastX)/dt; lastX=x; lastT=now; } }
    function endDrag(){ if(!dragging) return; dragging=false; const opened=1+pos/w; const TH=0.35, VE=0.35; if(mode==='open'){ (opened>TH||vX>VE)?openDrawer():closeDrawer(); } else { (opened<(1-TH)||vX<-VE)?closeDrawer():openDrawer(); } }
    edge.addEventListener('pointerdown',e=>{ edge.setPointerCapture(e.pointerId); beginOpen(e.clientX); });
    edge.addEventListener('pointermove', e=>{ if(dragging&&mode==='open')  moveTo(e.clientX); });
    edge.addEventListener('pointerup',   endDrag); edge.addEventListener('pointercancel',endDrag);
    drawer.addEventListener('pointerdown',e=>{ drawer.setPointerCapture?.(e.pointerId); beginClose(e.clientX); });
    drawer.addEventListener('pointermove', e=>{ if(dragging&&mode==='close') moveTo(e.clientX); });
    drawer.addEventListener('pointerup',   endDrag); drawer.addEventListener('pointercancel',endDrag);
    scrim.addEventListener('pointerdown', e=>{ scrim.setPointerCapture?.(e.pointerId); beginClose(e.clientX); });
    scrim.addEventListener('pointermove', e=>{ if(dragging&&mode==='close') moveTo(e.clientX); });
    scrim.addEventListener('pointerup',   endDrag); scrim.addEventListener('pointercancel',endDrag);

    /* ===== Навигация ===== */
    const views={calc:$('#view-calc'),settings:$('#view-settings'),about:$('#view-about')};
    const showView=k=>{ Object.values(views).forEach(v=>v.classList.remove('active')); (views[k]||views.calc).classList.add('active'); };
    $$('.navbtn').forEach(b=> b.addEventListener('click',()=>{ showView(b.dataset.view); closeDrawer(); }));

    /* ===== История ===== */
    const HIST_KEY='calc.history', historyList=$('#historyList');
    const loadHistory=()=>{try{return JSON.parse(localStorage.getItem(HIST_KEY)||'[]')}catch(_){return[]}};
    const saveHistory=a=>localStorage.setItem(HIST_KEY,JSON.stringify(a));
    const pushHistory=(expr,res)=>{ const a=loadHistory(); a.unshift({t:Date.now(),expr,res}); if(a.length>200)a.length=200; saveHistory(a); renderHistory(); };
    const formatTime=ts=>new Date(ts).toLocaleString();
    function renderHistory(){
      const a=loadHistory();
      historyList.innerHTML = a.length
        ? a.map(i=>`<li><b>${i.expr}</b> = ${i.res}<br><span style="color:var(--muted);font-size:12px">${formatTime(i.t)}</span></li>`).join('')
        : '<li style="color:var(--muted);padding:10px 12px">Пока пусто</li>';
    }
    $('#btnClearHistory').addEventListener('click',()=>{ saveHistory([]); renderHistory(); });

    /* ===== Нормализация опечаток/вариантов больших разрядов ===== */
    function normalizeNumeralTypos(s){
      return s
        // тысячи
        .replace(/\bт[ьи]сяч[а-я]*\b/gi,'тысяч')
        .replace(/\bтысяц[а-я]*\b/gi,'тысяч')
        .replace(/\bтыща\b/gi,'тысяч')
        .replace(/\bтыщ\b/gi,'тысяч')
        .replace(/\bтыс\.?\b/gi,'тысяч')
        // миллионы/миллиарды (включая популярные ошибочные распознавания)
        .replace(/\bмлн\b/gi,'миллионов')
        .replace(/\bмлрд\b/gi,'миллиардов')
        .replace(/\bмиль?и?он[а-я]*\b/gi,'миллион')
        .replace(/\bмили?ард[а-я]*\b/gi,'миллиард');
    }

    /* ===== Числа словами (тысячи/млн/млрд корректно) ===== */
    const units={ 'ноль':0,'один':1,'одна':1,'два':2,'две':2,'три':3,'четыре':4,'пять':5,'шесть':6,'семь':7,'восемь':8,'девять':9,
      'десять':10,'одиннадцать':11,'двенадцать':12,'тринадцать':13,'четырнадцать':14,'пятнадцать':15,'шестнадцать':16,'семнадцать':17,'восемнадцать':18,'девятнадцать':19 };
    const tens={ 'двадцать':20,'тридцать':30,'сорок':40,'пятьдесят':50,'шестьдесят':60,'семьдесят':70,'восемьдесят':80,'девяносто':90 };
    const hundreds={ 'сто':100,'двести':200,'триста':300,'четыреста':400,'пятьсот':500,'шестьсот':600,'семьсот':700,'восемьсот':800,'девятьсот':900 };
    const mags={ 'тысяча':1_000,'тысячи':1_000,'тысяч':1_000, 'миллион':1_000_000,'миллиона':1_000_000,'миллионов':1_000_000,
                 'миллиард':1_000_000_000,'миллиарда':1_000_000_000,'миллиардов':1_000_000_000 };
    const digitWord={'ноль':'0','один':'1','одна':'1','два':'2','две':'2','три':'3','четыре':'4','пять':'5','шесть':'6','семь':'7','восемь':'8','девять':'9'};
    const isNum=s=>/^[-+]?\d+(?:[.,]\d+)?$/.test(s);

    function parseGroup(tokens,i){
      let val=0;
      for(; i<tokens.length; i++){
        const w=tokens[i];
        if(w==='и') continue;
        if(hundreds[w]){ val+=hundreds[w]; continue; }
        if(tens[w]){ val+=tens[w]; continue; }
        if(units[w]!==undefined){ val+=units[w]; continue; }
        break;
      }
      return {val,i};
    }

    function wordsNumber(str){
      const cleaned = normalizeNumeralTypos(str).replace(/[.,!?;:]/g,' ').trim();
      const tokens = cleaned.split(/ +/).filter(Boolean);
      let i=0, total=0, lastMag=null, seenThousandAfterHigh=false;
      while(i<tokens.length){
        if(mags[tokens[i]]){
          const mul=mags[tokens[i]];
          total += (1*mul); // голая «тысяча/миллион»
          lastMag=mul;
          if(mul===1_000) seenThousandAfterHigh=true;
          i++; continue;
        }
        const {val,i:nextI}=parseGroup(tokens,i);
        if(nextI<tokens.length && mags[tokens[nextI]]){
          const mul=mags[tokens[nextI]];
          total += (val===0?1:val)*mul;
          lastMag=mul;
          if(mul===1_000) seenThousandAfterHigh=true;
          i=nextI+1;
        }else{
          let add=val;
          if(lastMag>=1_000_000 && !seenThousandAfterHigh){
            add = val*1000; // «один миллион пятьсот» -> 1 000 000 + 500*1000
            seenThousandAfterHigh=true;
          }
          total += add;
          i=nextI;
        }
      }
      return total;
    }

    function fromDigitsWithSuffix(s){
      const m=s.match(/^([0-9]+(?:[.,][0-9]+)?)\s*(к|k|тыс\.?|тысяча|тысячи|тысяч|млн\.?|миллион(?:а|ов)?|млрд\.?|миллиард(?:а|ов)?)$/i);
      if(!m) return null;
      const base=parseFloat(m[1].replace(',','.')); const suf=m[2].toLowerCase();
      let mult=1;
      if(suf==='к'||suf==='k'||suf.startsWith('тыс')||suf.startsWith('тыся')) mult=1_000;
      else if(suf.startsWith('млн')||suf.startsWith('миллион')) mult=1_000_000;
      else if(suf.startsWith('млрд')||suf.startsWith('миллиард')) mult=1_000_000_000;
      return String(base*mult);
    }

    function numberFromWordsOrDigits(raw){
      let s=(raw||'').trim().toLowerCase().replace(/ё/g,'е');
      if(!s) return '0';
      s = normalizeNumeralTypos(s);
      if(isNum(s)) return String(parseFloat(s.replace(',','.')));
      if(/^1\/2$/.test(s) || /^½$/.test(s)) return '0.5';

      // X с половиной / X 1/2 / X ½
      let mHalf = s.match(/^(.+?)\s+(?:с|и)?\s*половин(?:ой|а|у|е|ы)?$/);
      if(mHalf){ const base=wordsNumber(mHalf[1]); return String(base + 0.5); }
      let mHalfNum = s.match(/^(.+?)\s*(?:1\/2|½)$/);
      if(mHalfNum){ const base=wordsNumber(mHalfNum[1]); return String(base + 0.5); }

      // X и (0..9)
      let mDot = s.match(/^(.+?)\s+и\s+(ноль|один|одна|два|две|три|четыре|пять|шесть|семь|восемь|девять)$/);
      if(mDot){ const ip=wordsNumber(mDot[1]); const d=digitWord[mDot[2]]; return String(parseFloat(ip + '.' + d)); }

      // X и N десятых/сотых/тысячных
      let mFrac = s.match(/^(.+?)\s+и\s+(.+?)\s+(десятых?|сотых?|тысячных?)$/);
      if(mFrac){ const ip=wordsNumber(mFrac[1]); const n=wordsNumber(mFrac[2]); const pad=/^сот/.test(mFrac[3])?2:/^тысяч/.test(mFrac[3])?3:1; return ip+'.'+String(n).padStart(pad,'0'); }

      // X целых ... / X запятая ...
      let mDec=s.match(/^(.+?)\s+(целых?|целая|целое|запятая|точка)\s+(.+)$/);
      if(mDec){
        const ip=wordsNumber(mDec[1]); let rest=mDec[3].trim();
        let mu=rest.match(/^(.+?)\s+(десятых?|десятая|десятую|сотых?|сотая|сотую|тысячных?|тысячная|тысячную)$/);
        if(mu){ const n=wordsNumber(mu[1]); const pad=/^сот/.test(mu[2])?2:/^тысяч/.test(mu[2])?3:1; return ip+'.'+String(n).padStart(pad,'0'); }
        const onlyDig = rest.split(/\s+/).every(t=>digitWord[t]);
        const decStr = onlyDig ? rest.split(/\s+/).map(t=>digitWord[t]).join('') : String(wordsNumber(rest));
        return String(parseFloat(ip + '.' + decStr));
      }

      // 25к / 10 млн / 2 млрд
      const mag = fromDigitsWithSuffix(s) || fromDigitsWithSuffix(s.replace(/\s+/g,'')); if(mag) return mag;

      // обычное число словами
      return String(wordsNumber(s));
    }

    /* ===== Разбор выражения ===== */
    function parseExpression(textRaw){
      const text = textRaw.toLowerCase().replace(/ё/g,'е').replace(/,/g,'.').replace(/\s+/g,' ').trim();
      let t = text
        .replace(/руб(ль|ля|лей)/g,' ').replace(/коп(ейка|ейки|еек)/g,' ')
        .replace(/[−–—-]/g,'-')
        .replace(/(посчитай|посчитать|сколько будет|сколько|сосчитай|итого|в итоге|равно)/g,' ')
        .trim();
      t = normalizeNumeralTypos(t)
        .replace(/(умнож[а-я]*?)\s+на/g,' * ')
        .replace(/(помнож[а-я]*?)\s+на/g,' * ')
        .replace(/(раздели|разделить|подели|дели)\s+на/g,' / ')
        .replace(/\sплюс\s/g,' + ')
        .replace(/\sминус\s/g,' - ')
        .replace(/[×xх]/g,'*')
        .replace(/[÷:]/g,'/')
        .replace(/\s+/g,' ')
        .trim();

      const parts = t.split(/([+\-*/])/).filter(p=>p.trim()!=='');
      const out=[], disp=[];
      for(const part of parts){
        const s=part.trim();
        if(['+','-','*','/'].includes(s)){ out.push(s); disp.push(` ${s} `); continue; }
        const m = s.match(/^(.+?)\s*(%|процент(?:а|ов)?)$/);
        if(m){ const n=numberFromWordsOrDigits(m[1]); out.push(`(${n}/100)`); disp.push((m[1].trim()+'%')); continue; }
        const n = numberFromWordsOrDigits(s);
        out.push(n); disp.push(n);
      }
      const sanitized = out.join(''); const display = disp.join('').trim();
      if(!/^[0-9+\-*/.() ]+$/.test(sanitized)) throw new Error('Недопустимые символы');
      return {display, sanitized};
    }

    const calc = s=>{
      const v = Function('"use strict";return('+s.replace(/--/g,'+')+')')();
      if(!isFinite(v)||isNaN(v)) throw 0;
      return parseFloat(Number(v).toFixed(4)).toString();
    };

    /* ===== Подбор лучшей гипотезы ===== */
    function pickBestSmart(alts){
      if(!alts || !alts.length) return '';
      let best=alts[0], score=-1;
      for(const a of alts){
        const t=(a.transcript||a).toLowerCase().replace(/ё/g,'е');
        const conf=typeof a.confidence==='number'?a.confidence:0;
        const ops=(t.match(/(?:\s|^)(плюс|минус|умнож|раздел|подели|дели|на)(?=\s|$)/g)||[]).length+(t.match(/[+*×xх/÷:]/g)||[]).length;
        const s=conf*3+ops*2+t.length/80;
        if(s>score){ score=s; best=a; }
      }
      return best.transcript||best;
    }

    function pickBestSmart(alts){
      if(!alts || !alts.length) return '';
      let best='', bestScore=-1;
      const magWords=['тысяч','тыс','тысяча','млн','миллион','млрд','миллиард'];
      const opWords=[' плюс ',' минус ',' умнож',' раздел',' подели',' дели '];
      for(const a of alts){
        const t=(a.transcript||a).toLowerCase().replace(/ё/g,'е').trim();
        const conf=typeof a.confidence==='number'?a.confidence:0;
        let ops=0; for(const c of ['+','*','×','x','х','/','÷',':']){ if(t.indexOf(c)!==-1) ops++; }
        for(const ow of opWords){ if(t.indexOf(ow)!==-1) ops++; }
        const hasMag = magWords.some(w=>t.indexOf(w)!==-1);
        const hasNumWithSuffix = (()=>{ 
          const s=t.split('.').join('');
          const startsWithDigit = s.length && s[0]>='0' && s[0]<='9';
          let hasK=false; for(let i=1;i<s.length;i++){ if((s[i]==='к'||s[i]==='k') && s[i-1]>='0' && s[i-1]<='9'){ hasK=true; break; } }
          const suf=['тыс','тыс.','тысяча','тысячи','тысяч','млн','млн.','миллион','млрд','млрд.','миллиард'];
          const hasWord = startsWithDigit && suf.some(w=> s.indexOf(' '+w)!==-1 || s.endsWith(w));
          return hasK || hasWord; 
        })();
        const lenBonus=Math.min(t.length,120)/120;
        const score=conf*3 + ops*2 + (hasMag?5:0) + (hasNumWithSuffix?5:0) + lenBonus;
        if(score>bestScore){ bestScore=score; best=t; }
      }
      return best;
    }

    // MAG_RE удалён — используем hasMagnitudeRussian()
    // Вспомогательная функция: определяем наличие слов масштаба без 
    function hasMagnitudeRussian(t){
      const s=String(t).toLowerCase().replace(/ё/g,'е');
      // цифра + суффикс (10к / 10 тыс / 10 млн / 10 млрд)
      for(let i=1;i<s.length;i++){ const ch=s[i]; if((ch==='к'||ch==='k') && /[0-9]/.test(s[i-1])) return true; }
      if(s.includes('тыс')||s.includes('тысяч')||s.includes('тысяча')||s.includes('млн')||s.includes('миллион')||s.includes('млрд')||s.includes('миллиард')) return true;
      return false;
    }

    /* ===== Распознавание (Web + Cordova) ===== */
    // MAG2_RE удалён — используем hasMagnitudeRussian()
    let listening=false;
    const UI={ status:$('#status'), full:$('#full'), btnTitle:$('#btnTitle'),
      setListening(on){ this.status.innerHTML = on? '<div class="dots"><span></span><span></span><span></span></div>' : ''; this.btnTitle.textContent = on? 'СЛУШАЮ…' : 'НАЖМИТЕ'; },
      msg(m){ this.status.textContent=m; }
    };
    const recognizer={ mode:'none', available:false,
      start(){ UI.msg('Распознавание речи недоступно. Запусти через HTTPS/localhost в браузере или установи плагин speechrecognition в Cordova.'); navigator.vibrate && navigator.vibrate(30); },
      stop(){} };

    const handlePhrase=phrase=>{
      try{
        if(!phrase){ UI.msg('Речь не распознана.'); return; }
        const {display,sanitized}=parseExpression(phrase);
        const out=calc(sanitized);
        UI.full.textContent=`${display} = ${out}`;
        if(/[+\-*/]/.test(display)) pushHistory(display,out);
        UI.msg(`Вы сказали: "${phrase}"`);
      }catch{ UI.full.textContent='Ошибка'; UI.msg('Не удалось вычислить.'); }
    };

    // Web Speech
    (function setupWeb(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
      if(!SR || !secure) return;
      const rec=new SR(); rec.lang='ru-RU'; rec.interimResults=false; rec.maxAlternatives=8; rec.continuous=false;
      recognizer.mode='web'; recognizer.available=true;
      recognizer.start=function(){ if(listening) return; listening=true; UI.setListening(true); UI.full.textContent=''; try{rec.start();}catch{} };
      recognizer.stop=function(){ try{rec.stop();}catch{} };
      rec.onresult = (e) => {
        clearTimeout(listenTimer);
        const resList = Array.from(e.results || []);
        const segBest = resList.map(seg => pickAltPreferMagnitude(Array.from(seg)) || '');
        const joined = segBest.filter(Boolean).join(' ').replace(/\\s+/g,' ').trim();
        const flatAlts = resList.flatMap(seg => Array.from(seg).map(a => (a && a.transcript) ? a.transcript : String(a||'')));
        const candidates = [];
        if (joined) candidates.push(joined);
        candidates.push(...flatAlts);
        const withMag = candidates.find(hasMagnitudeRussian);
        const chosen = withMag || pickAltPreferMagnitude(candidates);
        handlePhrase(chosen || joined || (flatAlts[0]||''));
        stop();
      };
      rec.onerror =()=>{ UI.msg('Ошибка распознавания.'); stop(); };
      rec.onend   =()=>{ stop(); };
    })();

    // Cordova
    document.addEventListener('deviceready', ()=>{
      try{
        const rec = window.plugins && window.plugins.speechRecognition;
        if(!rec) return;
        recognizer.mode='cordova'; recognizer.available=true;
        recognizer.start=function(){
          if(listening) return;
          rec.isRecognitionAvailable(ok=>{
            if(!ok){ UI.msg('Распознавание речи недоступно на устройстве.'); return; }
            rec.hasPermission(has=>{
              const go=()=>{
                listening=true; UI.setListening(true); UI.full.textContent='';
                rec.startListening(
                  matches=>{ 
                    const arr=(matches||[]).map(s=>String(s).toLowerCase().replace(/ё/g,'е'));
                    const withMag=arr.find(hasMagnitudeRussian);
                    const chosen= withMag || pickBestSmart(arr);
                    handlePhrase(chosen);
                    stop();
                  },
                  ()=>{ UI.msg('Ошибка распознавания.'); stop(); },
                  { language:'ru-RU', matches:8, showPartial:false, showPopup:false }
                );
              };
              if(has) go(); else rec.requestPermission(go, ()=> UI.msg('Нет доступа к микрофону.'));
            }, ()=> UI.msg('Ошибка проверки разрешений.'));
          }, ()=> UI.msg('Ошибка доступа к распознаванию речи.'));
        };
        recognizer.stop=function(){ try{ rec.stopListening(()=>{},()=>{}); }catch{} };
      }catch{}
    }, false);

    function start(){ recognizer.start(); }
    function stop(){ if(!listening) return; recognizer.stop(); listening=false; UI.setListening(false); }

    // Кнопка
    $('#btnListen').addEventListener('click', e=>{
      e.preventDefault();
      if(!recognizer.available){ UI.msg('Нажал — ок. Но для работы нужен HTTPS/localhost (Web) или плагин в Cordova.'); navigator.vibrate && navigator.vibrate(30); return; }
      if(!listening) start(); else stop();
    });

    /* Старт */
    renderHistory();

  })();
  </script>
</body>
</html>
